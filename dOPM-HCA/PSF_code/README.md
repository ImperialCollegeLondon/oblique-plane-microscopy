#  README — MATLAB PSF Detection & Analysis Toolkit

*(with Bio-Formats / bf-tools integration)*

This directory contains two MATLAB scripts for extracting and quantifying the **point spread function (PSF)** from 3D bead images. The workflow is designed for multi-channel, multi-plane microscopy datasets and relies on **Bio-Formats** (via bf-tools) to import OME-TIF, ND2, CZI, LIF, and other proprietary formats.

Both scripts include a local copy of **bf-tools**
[https://github.com/pramukta/bf-tools](https://github.com/pramukta/bf-tools)
which wraps **loci_tools.jar** for MATLAB.

---

#  **PFS_detection.m — Bead Detection & Cropping**

### **Purpose**

Identify candidate fluorescent beads inside a 3D volume, filter them based on intensity and morphology, and extract small bead-centered cubes for quantitative PSF analysis.

### **What the script actually does (based on full code)**

#### **1. Loads image data using Bio-Formats (bfread.m)**

* Initializes Bio-Formats via `bfinit.m`
* Reads full 3D volume
* Supports multiple series and channels
* Converts Bio-Formats metadata to MATLAB structs

#### **2. Camera offset removal & normalization**

The script subtracts:

```
settings.offset_raw = 120;   % camera offset (hardcoded)
```

and optionally:

* rescales intensities
* handles 16-bit / 12-bit input

#### **3. Thresholding-based candidate detection**

The script computes:

* A global intensity histogram
* Adaptive thresholding (`settings.threshold`)
* Binary masks of bright voxels

Then uses:

* **3D connected component analysis**
* **local maxima filtering**
* intensity-based centroid refinement

#### **4. Bead quality filters**

The detection code filters beads by:

* minimum integrated intensity
* maximum bead radius
* isolation (rejects beads too close to others)
* distance from volume edges (Z and XY)

The script explicitly avoids beads touching image boundaries, ensuring clean sub-volumes.

#### **5. Extract bead sub-volumes**

For each valid bead:

* a cubic ROI of fixed half-width (configurable)
* centered on refined bead centroid
* stored in a cell array for later analysis

#### **6. Saves outputs to a `.mat` file**

Including:

* `beadVolumes{n}`: each bead’s 3D cropped volume
* `centroids(n,:)`
* `rawMetadata` (from Bio-Formats)
* intensity statistics
* number of accepted/rejected beads

**Output feeds directly into `PFS_analysis.m`.**

---

#  **PFS_analysis.m — Quantitative 3D PSF Measurement**

### **Purpose**

Compute PSF metrics (lateral & axial FWHM, symmetry, peak intensity) from bead sub-volumes generated by `PFS_detection.m`.

### **What the script actually does**

#### **1. Loads detection output**

The script imports:

```
beadVolumes  
centroids  
metadata  
pixel sizes (dx, dy, dz)
```

Pixel sizes are crucial for converting voxel FWHM → µm.

#### **2. Normalizes bead volumes**

* subtracts background
* centers each bead precisely using intensity-weighted centroid
* optionally smooths or crops additional margins

#### **3. Generates X, Y, Z intensity profiles**

For each bead:

* computes **max-projection** across orthogonal axes
* extracts **axial** (Z) and **lateral** (X/Y) line profiles
* locates the peak
* interpolates intensity curves for precise fitting

#### **4. Gaussian model fitting for FWHM**

The script fits:

```
I(x) = A * exp( - (x - μ)^2 / (2σ^2) ) + B
```

for X, Y, and Z independently.

Converts σ → FWHM:

```
FWHM = 2 * sqrt(2*log(2)) * sigma
```

Produces:

* FWHM_x
* FWHM_y
* FWHM_z
* lateral symmetry ratio (FWHM_x / FWHM_y)
* axial-to-lateral ratio (FWHM_z / ((FWHM_x+FWHM_y)/2))

#### **5. Aggregates statistics across all beads**

The script outputs:

* median & MAD of FWHM values
* histograms & plots
* per-bead tables
* summary struct `PSFStats` containing all metrics

#### **6. Saves results**

Typically saves:

* `PSFStats.mat`
* plots (if enabled)
* CSV export (optional)

---

#  **Dependency: bf-tools (Bio-Formats for MATLAB)**

Both scripts rely on **bf-tools**, which wraps Bio-Formats via Java.

### Included files:

```
bf-tools/bfinit.m  
bf-tools/bfread.m  
bf-tools/bfinfo.m  
bf-tools/bfstream.m  
bf-tools/ext/loci_tools.jar  
```

### Required acknowledgment:

> **bf-tools (Bio-Formats wrappers for MATLAB)**
> Copyright (c) 2011, Pramukta Kumar
> BSD License (see bf-tools/LICENSE)

---

#  **Typical Workflow**

1. **Detect beads**

   ```matlab
   PFS_detection
   ```

   Produces beadVolumes + metadata.

2. **Analyze PSF**

   ```matlab
   PFS_analysis
   ```

   Computes FWHM_x, FWHM_y, FWHM_z and summary stats.

3. **Use the results to evaluate imaging performance, optical alignment, or system aberrations.**

---

#  **Summary Table**

| Script              | Purpose                       | Key Functions                                                           |
| ------------------- | ----------------------------- | ----------------------------------------------------------------------- |
| **PFS_detection.m** | Detect beads & crop bead ROIs | thresholding, centroiding, 3D connected components, Bio-Formats reading |
| **PFS_analysis.m**  | Fit PSF & compute metrics     | Gaussian fitting, FWHM calc, intensity profiling                        |
| **bf-tools**        | Image importer layer          | bfread, bfinit, loci_tools.jar                                          |






